<template>
  <div class="studio">
    <header class="hero">
      <div class="hero__eyebrow">Routing Studio</div>
      <h1 class="hero__title">Build a routing rule in minutes</h1>
      <p class="hero__subtitle">
        Define who should own a lead, contact, or account based on simple rules. The engine handles
        matching and round robin behind the scenes.
      </p>
    </header>

    <section class="signal">
      <template for:each={signalCards} for:item="card">
        <div class="signal-card" key={card.id}>
          <div class="signal-card__title">{card.title}</div>
          <div class="signal-card__body">{card.body}</div>
        </div>
      </template>
    </section>

    <section class="builder">
      <div class="builder__glow"></div>
      <div class="body builder-grid">
      <section class="panel">
        <div class="panel__header">
          <h2 class="panel__title">Conditions</h2>
          <p class="panel__subtitle">Add one or more filters. Use AND/OR match logic in the rule.</p>
        </div>

        <template if:true={hasConditionOptions}>
          <div class="conditions">
            <template for:each={conditionRows} for:item="row" for:index="index">
              <div class="condition" key={row.id}>
                <lightning-combobox
                  class="condition__field"
                  label="Field"
                  value={row.field}
                  options={resolvedFieldOptions}
                  data-index={index}
                  data-field="field"
                  onchange={handleConditionChange}
                ></lightning-combobox>

                <lightning-combobox
                  class="condition__operator"
                  label="Operator"
                  value={row.operator}
                  options={resolvedOperatorOptions}
                  data-index={index}
                  data-field="operator"
                  onchange={handleConditionChange}
                ></lightning-combobox>

                <lightning-input
                  class="condition__value"
                  type="text"
                  label="Value"
                  value={row.value}
                  data-index={index}
                  data-field="value"
                  onchange={handleConditionChange}
                ></lightning-input>

                <lightning-button-icon
                  class="condition__remove"
                  icon-name="utility:close"
                  alternative-text="Remove"
                  title="Remove"
                  data-index={index}
                  onclick={removeCondition}
                ></lightning-button-icon>
              </div>
            </template>

            <div class="condition-actions">
              <lightning-button
                variant="neutral"
                label="Add condition"
                onclick={addCondition}
              ></lightning-button>
            </div>
            <template if:true={usingFallbackOptions}>
              <div class="conditions__note">
                Using the studio defaults for field and operator menus.
              </div>
            </template>
          </div>
        </template>
        <template if:false={hasConditionOptions}>
          <div class="loading">Loading condition options...</div>
        </template>
      </section>

      <section class="panel">
        <div class="panel__header">
          <h2 class="panel__title">Who Should Own It</h2>
          <p class="panel__subtitle">Name the rule and route it to the right group.</p>
        </div>

        <lightning-record-edit-form
          object-api-name={ruleObjectApiName}
          onsuccess={handleRuleSuccess}
          onerror={handleRuleError}
          onsubmit={handleRuleSubmit}
        >
          <div class="form-grid">
            <lightning-input-field
              field-name={ruleNameField}
              data-field="name"
              onchange={handleRuleFieldChange}
            ></lightning-input-field>
            <lightning-input-field
              field-name={ruleDescriptionField}
              data-field="description"
              onchange={handleRuleFieldChange}
            ></lightning-input-field>
            <lightning-input-field
              field-name={ruleGroupField}
              data-field="groupId"
              onchange={handleRuleFieldChange}
            ></lightning-input-field>
            <lightning-input-field
              field-name={ruleMatchLogicField}
              data-field="matchLogic"
              onchange={handleRuleFieldChange}
            ></lightning-input-field>
            <lightning-input-field
              field-name={rulePriorityField}
              data-field="priority"
              onchange={handleRuleFieldChange}
            ></lightning-input-field>
          </div>

          <div class="actions">
            <lightning-button
              variant="brand"
              type="submit"
              label="Create Rule"
              disabled={isSaving}
            ></lightning-button>
          </div>
        </lightning-record-edit-form>
      </section>
      </div>
    </section>

    <section class="panel preview">
      <div class="panel__header">
        <h2 class="panel__title">Rule Preview</h2>
        <p class="panel__subtitle">A plain-English summary of the rule you are creating.</p>
      </div>
      <div class="preview__body">
        <template if:true={previewLines.length}>
          <template for:each={previewLines} for:item="line">
            <div class="preview__line" key={line}>{line}</div>
          </template>
        </template>
        <template if:false={previewLines.length}>
          <div class="preview__empty">
            Add rule details and at least one condition to see a preview.
          </div>
        </template>
      </div>
    </section>

    <section class="panel atlas">
      <div class="panel__header">
        <h2 class="panel__title">Routing Atlas</h2>
        <p class="panel__subtitle">
          A live map of which rules feed each routing group or queue.
        </p>
      </div>
      <template if:true={hasAtlasData}>
        <div class="atlas__grid">
          <template for:each={groupedRuleSets} for:item="group">
            <div class="atlas-group" key={group.id}>
              <div class="atlas-group__header">
                <div>
                  <div class="atlas-group__title">{group.name}</div>
                  <div class="atlas-group__desc">{group.description}</div>
                </div>
                <div class="atlas-group__meta">{group.ruleCount} rules</div>
              </div>
              <div class="atlas-group__body">
                <div class="atlas-rail"></div>
                <div class="atlas-rules">
                  <template for:each={group.rules} for:item="rule">
                    <div class="atlas-rule" key={rule.id}>
                      <div class="atlas-rule__name">{rule.name}</div>
                      <div class="atlas-rule__meta">
                        <span>{rule.matchLogicLabel}</span>
                        <span>Priority {rule.priority}</span>
                        <span>{rule.statusLabel}</span>
                      </div>
                      <template if:true={rule.description}>
                        <div class="atlas-rule__desc">{rule.description}</div>
                      </template>
                    </div>
                  </template>
                </div>
              </div>
            </div>
          </template>
        </div>
      </template>
      <template if:false={hasAtlasData}>
        <div class="atlas__empty">
          No routing rules yet. Create your first rule above and it will show up here.
        </div>
      </template>
    </section>

    <section class="panel playbook">
      <div class="panel__header">
        <h2 class="panel__title">Studio Playbook</h2>
        <p class="panel__subtitle">A light-touch guide that keeps RevOps in the flow.</p>
      </div>
      <div class="playbook__grid">
        <div class="playbook__steps">
          <div class="step-card">
            <div class="step-card__number">01</div>
            <div class="step-card__title">Name the intent</div>
            <div class="step-card__body">
              Give the rule a clear name and pick a routing group.
            </div>
          </div>
          <div class="step-card">
            <div class="step-card__number">02</div>
            <div class="step-card__title">Describe the lead</div>
            <div class="step-card__body">
              Add conditions like region, source, or account tier.
            </div>
          </div>
          <div class="step-card">
            <div class="step-card__number">03</div>
            <div class="step-card__title">Confirm the logic</div>
            <div class="step-card__body">
              Review the preview. The routing engine applies smart matching automatically.
            </div>
          </div>
        </div>
        <div class="playbook__guidance">
          <div class="guidance__title">Live Guidance</div>
          <template for:each={guidanceTips} for:item="tip">
            <div class="guidance__item" key={tip}>{tip}</div>
          </template>
          <div class="guidance__note">
            Existing account matches and round robin weighting are handled by the engine.
          </div>
        </div>
      </div>
    </section>

    <section class="panel quickstart">
      <div class="panel__header">
        <h2 class="panel__title">Quick Start Templates</h2>
        <p class="panel__subtitle">Kick off a polished rule and tweak the details.</p>
      </div>
      <div class="quickstart__grid">
        <template for:each={sampleRules} for:item="sample">
          <div class="quick-card" key={sample.id}>
            <div class="quick-card__title">{sample.label}</div>
            <div class="quick-card__desc">{sample.description}</div>
            <lightning-button
              variant="brand-outline"
              label="Use template"
              data-sample-id={sample.id}
              onclick={applySample}
            ></lightning-button>
          </div>
        </template>
      </div>
    </section>

    <template if:true={isSaving}>
      <div class="saving">
        <lightning-spinner alternative-text="Saving" size="medium"></lightning-spinner>
      </div>
    </template>
  </div>
</template>
